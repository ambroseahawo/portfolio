---
import type { CollectionEntry } from "astro:content"
import ArticlesList from "../components/ArticlesList.astro"
import FeaturedProjects from "../components/FeaturedProjects.astro"
import Tabs from "../components/Tabs.astro"
import Tutorials from "../components/Tutorials.astro"
import { articleCategories } from "../data/articleCategories"
import { tutorials } from "../data/tutorials"
import Layout from "../layouts/Layout.astro"
import { getArticlesByCategory, getSortedArticles } from "../lib/articles"

let sortedArticles: CollectionEntry<"articles">[] = []
try {
  sortedArticles = await getSortedArticles()
} catch (error) {
  console.error("Error loading articles:", error)
}

// Sort tutorials by publishedAt date in descending order
const sortedTutorials = [...tutorials].sort(
  (a, b) =>
    new Date(b.publishedAt).getTime() - new Date(a.publishedAt).getTime()
)

// Only show category tabs that have articles
const categoryTabs = articleCategories
  .filter((cat) => {
    const articlesInCategory = getArticlesByCategory(sortedArticles, cat.id)
    return articlesInCategory.length > 0
  })
  .map((cat) => ({
    id: cat.id,
    label: cat.label,
  }))

const tabs = [{ id: "all", label: "All" }, ...categoryTabs]

if (sortedTutorials.length > 0)
  tabs.push({ id: "tutorials", label: "Tutorials" })
---

<Layout title="Infranotes - Home">
  <div class="c4a0m">
    <div class="c8b8k">
      <div class="c7qcc">
        <!-- Latest Articles -->
        <section>
          <h2 class="cpynq c670g c8dzi cec5b">Latest Articles</h2>

          <!-- Tabs -->
          <Tabs tabs={tabs} activeTab="all" />

          <!-- All articles tab -->
          <div class="tab-content" data-tab="all">
            <ArticlesList articles={sortedArticles} showCategory={true} />
          </div>

          <!-- Category tabs -->
          {
            categoryTabs.map((tab) => {
              const categoryArticles = getArticlesByCategory(
                sortedArticles,
                tab.id
              )
              return (
                <div class="tab-content hidden" data-tab={tab.id}>
                  <ArticlesList
                    articles={categoryArticles}
                    showCategory={false}
                  />
                </div>
              )
            })
          }

          <!-- Tutorials tab content -->
          {
            sortedTutorials.length > 0 && (
              <div class="tab-content hidden" data-tab="tutorials">
                <Tutorials tutorials={sortedTutorials} />
              </div>
            )
          }
        </section>

        <Tutorials tutorials={sortedTutorials} isFeatured={true} />
        <FeaturedProjects />
      </div>
    </div>
  </div>
</Layout>
