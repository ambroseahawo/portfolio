---
import { getCollection, type CollectionEntry } from "astro:content"
import { JSDOM } from "jsdom"
import { marked, type MarkedOptions } from "marked"
import Layout from "../../layouts/Layout.astro"

export async function getStaticPaths() {
  const articles = await getCollection("articles")
  return articles.map((article) => ({
    params: { slug: article.slug },
    props: { article },
  }))
}

const { article } = Astro.props as { article: CollectionEntry<"articles"> }
// const { Content } = await article.render()

let htmlContent = ""
let updatedHtml = ""

// Convert markdown to HTML
const markedOptions: MarkedOptions = {
  gfm: true,
  // breaks: true,
}

try {
  htmlContent = await Promise.resolve(
    marked.parse(article.body || "", markedOptions)
  )
  // Use JSDOM to add IDs to h2s and extract TOC
  const dom = new JSDOM(htmlContent)

  // Wrap all content in sections
  const body = dom.window.document.body
  const allElements = Array.from(body.children)

  // Create first wrapper for content before first h2
  let currentWrapper = dom.window.document.createElement("div")
  currentWrapper.classList.add("c9gi4")
  body.insertBefore(currentWrapper, body.firstChild)

  for (const element of allElements) {
    if (element.tagName === "H2") {
      // Create new wrapper for h2 and its content
      currentWrapper = dom.window.document.createElement("div")
      currentWrapper.classList.add("c9gi4")
      body.insertBefore(currentWrapper, element)
      currentWrapper.appendChild(element)
    } else {
      // Move element to current wrapper
      currentWrapper.appendChild(element)
    }
  }

  // Add classes to h2s
  const h2s = dom.window.document.querySelectorAll("h2")
  h2s.forEach((h2) => {
    h2.classList.add("cxmc9", "cg0ht", "cpynq", "crvmr")
  })

  // Add classes to h3s
  const h3s = dom.window.document.querySelectorAll("h3")
  h3s.forEach((h3) => {
    h3.classList.add("cxmc9", "cg0ht", "cpynq", "cjvvo")
  })

  // Add classes to divs
  const divs = dom.window.document.querySelectorAll("div")
  divs.forEach((div) => {
    div.classList.add("c9gi4")
  })

  // Add classes to strong
  const strongs = dom.window.document.querySelectorAll("strong")
  strongs.forEach((strong) => {
    strong.classList.add("cxmc9", "cg0ht", "cnp10")
  })

  // Add classes to a
  const as = dom.window.document.querySelectorAll("a")
  as.forEach((a) => {
    a.classList.add("cm6cq", "chugl", "cnp10")
  })
  // Add classes to ul
  const uls = dom.window.document.querySelectorAll("ul")
  uls.forEach((ul) => {
    ul.classList.add("c2czg", "c0c3z", "csndo")
  })

  // Add classes to span
  // const spans = dom.window.document.querySelectorAll("span")
  // spans.forEach((span) => {
  //   span.classList.add("ct35c")
  // })

  // Add classes to code
  // const codes = dom.window.document.querySelectorAll("code")
  // codes.forEach((code) => {
  //   code.classList.add("c4j9y")
  // })

  // Add classes to pre
  // const pres = dom.window.document.querySelectorAll("pre")
  // pres.forEach((pre) => {
  //   pre.classList.add(
  //     "cgr7g",
  //     "c2bb0",
  //     "ca9r6",
  //     "cx6ng",
  //     "c9xwx",
  //     "cme8e",
  //     "cmy5q"
  //   )
  // })

  // Inject classes and styles into all images in the article content
  const imageElements = dom.window.document.querySelectorAll("img")
  imageElements.forEach((img) => {
    img.classList.add("c8pgj")
    img.width = 692
    img.height = 390
  })

  updatedHtml = dom.window.document.body.innerHTML
} catch (error) {
  console.error("Error processing article content:", error)
  updatedHtml = article.body || ""
}
---

<Layout title={article.data.title}>
  <div class="c4a0m">
    <div class="c8b8k">
      <!-- Back -->
      <div class="cec5b">
        <a
          class="cg3vi cj965 cry3b c81t6 cax03 c3iz2 chugl cz5kb c90wr"
          href="/"
        >
          <span class="c4g5b">Back</span>
          <svg xmlns="http://www.w3.org/2000/svg" width="34" height="34">
            <path
              class="cjnrq"
              d="m16.414 17 3.293 3.293-1.414 1.414L13.586 17l4.707-4.707 1.414 1.414z"
            ></path>
          </svg>
        </a>
      </div>

      <article>
        <!-- Post header -->
        <header>
          <div class="cpk71 c5a0p c0kco cfwvb">
            <!-- Post date -->
            <div class="c2bb0 cd99g ck5r6">
              <span class="chugl">—</span>
              {
                article.data.publishedAt.toLocaleDateString("en-US", {
                  year: "numeric",
                  month: "short",
                  day: "numeric",
                })
              }
              <span class="cxuy4 crnoq">·</span>
              {article.data.readTime} Min read
            </div>
            <!-- Share buttons -->
            <ul class="cz5kb">
              <li>
                <a
                  class="cqs8k cpvt7 chlgd cfup8 crnoq c5a0p cofma chtu4 coi2g cfwvb"
                  href="#0"
                  aria-label="Twitter"
                >
                  <svg
                    class="cjnrq csb9v c2298"
                    viewBox="0 0 32 32"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="m13.063 9 3.495 4.475L20.601 9h2.454l-5.359 5.931L24 23h-4.938l-3.866-4.893L10.771 23H8.316l5.735-6.342L8 9h5.063Zm-.74 1.347h-1.457l8.875 11.232h1.36l-8.778-11.232Z"
                    ></path>
                  </svg>
                </a>
              </li>
              <li>
                <a
                  class="cqs8k cpvt7 chlgd cfup8 crnoq c5a0p cofma chtu4 coi2g cfwvb"
                  href="#0"
                  aria-label="Facebook"
                >
                  <svg
                    class="cjnrq csb9v c2298"
                    viewBox="0 0 32 32"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M14.023 24 14 17h-3v-3h3v-2c0-2.7 1.672-4 4.08-4 1.153 0 2.144.086 2.433.124v2.821h-1.67c-1.31 0-1.563.623-1.563 1.536V14H21l-1 3h-2.72v7h-3.257Z"
                    ></path>
                  </svg>
                </a>
              </li>
              <li>
                <a
                  class="cqs8k cpvt7 chlgd cfup8 crnoq c5a0p cofma chtu4 coi2g cfwvb"
                  href="#0"
                  aria-label="Share"
                >
                  <svg
                    class="cjnrq csb9v c2298"
                    viewBox="0 0 32 32"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M20 14c1.654 0 3-1.346 3-3s-1.346-3-3-3-3 1.346-3 3c0 .223.029.439.075.649l-3.22 2.012A2.97 2.97 0 0 0 12 13c-1.654 0-3 1.346-3 3s1.346 3 3 3a2.97 2.97 0 0 0 1.855-.661l3.22 2.012c-.046.21-.075.426-.075.649 0 1.654 1.346 3 3 3s3-1.346 3-3-1.346-3-3-3a2.97 2.97 0 0 0-1.855.661l-3.22-2.012c.046-.21.075-.426.075-.649 0-.223-.029-.439-.075-.649l3.22-2.012A2.97 2.97 0 0 0 20 14Z"
                    ></path>
                  </svg>
                </a>
              </li>
            </ul>
          </div>
          <h1 class="cpynq cjd5a ciz93">{article.data.title}</h1>
        </header>
        <div class="cxslc c2bb0 cr8w3" set:html={updatedHtml} />
      </article>
    </div>
  </div>
</Layout>
